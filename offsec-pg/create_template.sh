#!/bin/bash
#
# Usage: ./create_template.sh <VM name> <remote IP> [options...]
#  -h, --help	This help text
#  -p, --port	Local listen port
#
# Example: ./create_template.sh VirtualMachine 192.169.139.24 192.168.64.153

# the help() function displays a help text
help() {
  awk 'NR > 2 {
    if (/^#/) { sub("^# ?", ""); print }
    else { exit }
  }' $0
}

# default variables
LOCAL_PORT="4444"

# parse arguments
while (( $# > 0 ))
do
  case $1 in
    -h | --help)
      help
      exit 0
      ;;
    -p | --port)
      LOCAL_PORT="$2"
      shift # past argument
      ;;
    -* | --*)
      echo "Unonown option $1"
      exit 1
      ;;
    *)
      if [ -n "$VM_NAME" ]; then
        REMOTE_IP="$1"
      else
        VM_NAME="$1"
      fi
      ;;
  esac
  shift # past value
done

# create template
mkdir $VM_NAME
cp ../README.md ./$VM_NAME/$VM_NAME.md

# get LOCAL_IP
LOCAL_IP=$(ip addr show dev tun0 | sed '1,2d' | sed '2,$d' | sed 's/.*inet \([0-9,\.]*\).*\([0-9]*\)/\1/')

# replace variables
sed -i s/{VM_NAME}/$VM_NAME/g ./$VM_NAME/$VM_NAME.md
sed -i s/{REMOTE_IP}/$REMOTE_IP/g ./$VM_NAME/$VM_NAME.md
sed -i s/{LOCAL_IP}/$LOCAL_IP/g ./$VM_NAME/$VM_NAME.md
sed -i s/{LOCAL_PORT}/$LOCAL_PORT/g ./$VM_NAME/$VM_NAME.md
